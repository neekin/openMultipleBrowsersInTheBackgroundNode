# Puppeteer å¤šå®ä¾‹è¿œç¨‹æ§åˆ¶ç³»ç»Ÿ

## é¡¹ç›®ç®€ä»‹
åŸºäº Node.js + Express + Puppeteer çš„å¤šå®ä¾‹æµè§ˆå™¨è¿œç¨‹æ§åˆ¶ç³»ç»Ÿï¼Œæ”¯æŒ session/cookie éš”ç¦»ã€æŒ‡çº¹éšæœºåŒ–ã€å®ä¾‹åå°å¸¸é©»ã€WebSocket è¿œç¨‹æ“ä½œç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§
- ğŸš€ å¤šå®ä¾‹ç®¡ç†ï¼šåˆ›å»ºã€åˆ é™¤ã€æ¢å¤æµè§ˆå™¨å®ä¾‹
- ğŸ”’ ä¼šè¯éš”ç¦»ï¼šæ¯ä¸ªå®ä¾‹ç‹¬ç«‹çš„ userDataDirï¼Œå®Œå…¨éš”ç¦» cookies/session
- ğŸ­ æŒ‡çº¹éšæœºï¼šéšæœºåŒ– User-Agentã€è§†å£å¤§å°ç­‰æµè§ˆå™¨æŒ‡çº¹
- ğŸ“± å®æ—¶æ§åˆ¶ï¼šWebSocket å®æ—¶æˆªå›¾ã€é¼ æ ‡é”®ç›˜æ“ä½œ
- ğŸ’¾ æŒä¹…åŒ–å­˜å‚¨ï¼šSQLite æ•°æ®åº“å­˜å‚¨å®ä¾‹ä¿¡æ¯ï¼Œæ”¯æŒæœåŠ¡é‡å¯åæ¢å¤
- ğŸ·ï¸ æ ‡ç­¾é¡µç®¡ç†ï¼šæ”¯æŒå¤šæ ‡ç­¾é¡µåˆ‡æ¢ã€åˆ·æ–°ã€å…³é—­æ“ä½œ
- ğŸ¯ è‡ªåŠ¨æ¢å¤ï¼šæœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤å†å²å®ä¾‹

## é¡¹ç›®ç»“æ„
```
â”œâ”€â”€ index.js              # ä¸»æœåŠ¡æ–‡ä»¶ï¼Œè´Ÿè´£æœåŠ¡å™¨å¯åŠ¨å’Œå…¨å±€é…ç½®
â”œâ”€â”€ config.js             # ç»Ÿä¸€é…ç½®ç®¡ç†
â”œâ”€â”€ browserManager.js     # æµè§ˆå™¨å®ä¾‹ç®¡ç†æ¨¡å—
â”œâ”€â”€ wsManager.js          # WebSocket è¿æ¥å’Œæ“ä½œå¤„ç†
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ browsers.js       # å®ä¾‹ç®¡ç† API è·¯ç”±
â”œâ”€â”€ static/
â”‚   â””â”€â”€ index.html        # å‰ç«¯ç•Œé¢
â”œâ”€â”€ user_data/            # ç”¨æˆ·æ•°æ®ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ browsers.db           # SQLite æ•°æ®åº“ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ package.json          # é¡¹ç›®ä¾èµ–
â””â”€â”€ ecosystem.config.js   # PM2 é…ç½®æ–‡ä»¶
```

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### index.js - ä¸»æœåŠ¡æ–‡ä»¶
- æœåŠ¡å™¨å¯åŠ¨å’ŒåŸºç¡€é…ç½®
- æ•°æ®åº“åˆå§‹åŒ–
- è·¯ç”±æŒ‚è½½
- WebSocket æœåŠ¡å¯åŠ¨
- ä¼˜é›…å…³é—­å¤„ç†

### config.js - é…ç½®ç®¡ç†
- æœåŠ¡å™¨é…ç½®ï¼ˆç«¯å£ã€ä¸»æœºï¼‰
- æ•°æ®åº“è·¯å¾„é…ç½®
- æµè§ˆå™¨å¯åŠ¨å‚æ•°
- WebSocket é…ç½®
- æŒ‡çº¹ç”Ÿæˆè§„åˆ™

### browserManager.js - æµè§ˆå™¨ç®¡ç†
- Chromium è·¯å¾„è‡ªåŠ¨æ£€æµ‹
- éšæœºæŒ‡çº¹ç”Ÿæˆ
- æµè§ˆå™¨å®ä¾‹å¯åŠ¨
- å†å²å®ä¾‹æ¢å¤
- æ‰¹é‡å®ä¾‹ç®¡ç†

### wsManager.js - WebSocket å¤„ç†
- WebSocket è¿æ¥ç®¡ç†
- å®æ—¶æˆªå›¾æ¨é€
- é¼ æ ‡é”®ç›˜äº‹ä»¶å¤„ç†
- æ ‡ç­¾é¡µæ“ä½œå¤„ç†
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### routes/browsers.js - API è·¯ç”±
- POST /browsers/create - åˆ›å»ºæ–°å®ä¾‹
- GET /browsers - è·å–å®ä¾‹åˆ—è¡¨
- GET /browsers/:id/pages - è·å–æ ‡ç­¾é¡µä¿¡æ¯
- POST /browsers/:id/restore - æ¢å¤å†å²å®ä¾‹
- DELETE /browsers/:id - åˆ é™¤å®ä¾‹

## å®‰è£…å’Œè¿è¡Œ

### ç¯å¢ƒè¦æ±‚
- Node.js 16+
- ç³»ç»Ÿå®‰è£… Chromium/Chrome æµè§ˆå™¨

### å®‰è£…ä¾èµ–
```bash
npm install
```

### å¼€å‘æ¨¡å¼è¿è¡Œ
```bash
npm run dev
```

### ç”Ÿäº§æ¨¡å¼è¿è¡Œ
```bash
node index.js
```

### PM2 éƒ¨ç½²
```bash
npm install -g pm2
pm2 start ecosystem.config.js
```

## PM2 é…ç½®æ³¨æ„äº‹é¡¹
åœ¨ `ecosystem.config.js` ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®é˜²æ­¢é¢‘ç¹é‡å¯ï¼š
```javascript
module.exports = {
  apps: [{
    name: 'puppeteer-manager',
    script: 'index.js',
    ignore_watch: ['user_data', 'browsers.db', 'node_modules']
  }]
}
```

## API æ–‡æ¡£

### åˆ›å»ºå®ä¾‹
```bash
curl -X POST http://localhost:3000/browsers/create \
  -H "Content-Type: application/json" \
  -d '{"url": "https://example.com"}'
```

### è·å–å®ä¾‹åˆ—è¡¨
```bash
curl http://localhost:3000/browsers
```

### åˆ é™¤å®ä¾‹
```bash
curl -X DELETE http://localhost:3000/browsers/{instance_id}
```

## WebSocket æ“ä½œ
è¿æ¥åœ°å€ï¼š`ws://localhost:3000/browsers/ws/operate/{instance_id}`

æ”¯æŒçš„æ“ä½œç±»å‹ï¼š
- `click` - é¼ æ ‡ç‚¹å‡»
- `mousemove` - é¼ æ ‡ç§»åŠ¨
- `keydown/keyup` - é”®ç›˜æŒ‰é”®
- `wheel` - é¼ æ ‡æ»šè½®
- `switchTab` - åˆ‡æ¢æ ‡ç­¾é¡µ
- `refreshTab` - åˆ·æ–°æ ‡ç­¾é¡µ
- `closeTab` - å…³é—­æ ‡ç­¾é¡µ
- `getTabs` - è·å–æ ‡ç­¾é¡µåˆ—è¡¨

## æŠ€æœ¯æ ˆ
- **åç«¯**: Node.js + Express
- **æ•°æ®åº“**: SQLite3
- **æµè§ˆå™¨æ§åˆ¶**: Puppeteer
- **å®æ—¶é€šä¿¡**: WebSocket (ws)
- **å‰ç«¯**: åŸç”Ÿ HTML/CSS/JavaScript

## å¼€å‘å’Œç»´æŠ¤
- ä»£ç é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ”¯æŒé…ç½®åŒ–ç®¡ç†
- ä¼˜é›…çš„è¿›ç¨‹å…³é—­å¤„ç†

## æ³¨æ„äº‹é¡¹
1. ç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿå†…å­˜æ”¯æŒå¤šä¸ªæµè§ˆå™¨å®ä¾‹
2. å®šæœŸæ¸…ç† `user_data` ç›®å½•é¿å…ç£ç›˜ç©ºé—´ä¸è¶³
3. ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ PM2 è¿›è¡Œè¿›ç¨‹ç®¡ç†
4. é˜²ç«å¢™éœ€è¦å¼€æ”¾å¯¹åº”ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
